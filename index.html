<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css"
    />
    <title>Corechan</title>
    <style>
      a {
        text-decoration: none;
      }
    </style>
    <script>
      //const HOST = "https://tchan.art";
      const HOST = "http://localhost:443";
      const POSTS_ID = "#posts";
      const SEARCH_ID = "#search";
      const COMMENT_ID = "#comment";
      const POST_TAG_LENGTH = 32;
      const DEFAULT_TAG = "home";
      const VIEW = {
        TAG: "tag",
        REPLIES: "replies",
      };

      function humanize(s) {
        const date = Date.parse(s);
        let t = Date.now() - date;
        t /= 1000;
        if (t < 60) {
          return "now";
        }
        t /= 60;
        if (t < 60) {
          return `${Math.floor(t)}m`;
        }
        t /= 60;
        if (t < 60) {
          return `${Math.floor(t)}h`;
        }
        t /= 24;
        return `${Math.floor(t)}d`;
      }

      function parseTag(s) {
        const tag = s.match(/[a-zA-Z0-9]+/i)[0];
        if (tag.length == POST_TAG_LENGTH) {
          return { tag, pretty: `@${tag}`, isPost: true };
        }
        return { tag, pretty: `#${tag}`, isPost: false };
      }

      /**
       * Add links to tags.
       */
      function processText(s) {
        return s.replaceAll(
          /[#@][a-zA-Z0-9]+/gi,
          (match) =>
            `<a href="javascript:setTagParam('${match.substr(
              1
            )}')">${match}</a>`
        );
      }

      function updateTag(tag) {
        console.log("updateTag", tag);
        updateTagChildren(tag);
      }

      function clearCards() {
        document.querySelector(POSTS_ID).innerHTML = "";
      }

      function apiGetPost(postId, postCallback) {
        fetch(`${HOST}/post/${postId}`)
          .then((response) => response.json())
          .then((data) => data.forEach(postCallback));
      }

      function apiGetReplies(postId, postCallback) {
        fetch(`${HOST}/replies/${postId}`)
          .then((response) => response.json())
          .then((data) => data.forEach(postCallback));
      }

      function apiGetTag(tag, postCallback) {
        fetch(`${HOST}/tag/${tag}`)
          .then((response) => response.json())
          .then((data) => data.forEach(postCallback));
      }

      function apiPostPost(parentPostId, tags, text) {
        fetch(`${HOST}/post`, {
          method: "POST",
          body: JSON.stringify({
            ParentPostId: parentPostId,
            Tags: tags,
            Text: text,
          }),
        }).then((response) => window.location.reload());
      }

      function parseTags(s) {
        const matches = s.match(/#[a-zA-Z0-9]+/gi);
        if (matches) {
          return matches.map((match) => match.substr(1));
        }
        return [];
      }

      function postComment() {
        const text = document.querySelector(COMMENT_ID).value;
        const params = getParams();
        console.log("postComment", text, params);

        // TODO: Fix tags
        apiPostPost(params.postId, parseTags(text), text);
      }

      function searchTag() {
        const tag = document.querySelector(SEARCH_ID).value;
        console.log("searchTag", tag);
        setTagParam(tag);
        //updateTagChildren(tag);
      }

      function renderCard(post) {
        const card = document.createElement("div");
        card.className = "card mt-3 mb-3";

        const body = document.createElement("div");
        body.className = "card-body";

        const title = document.createElement("p");
        title.className = "card-title text-muted mb-3";
        // TODO: <time>
        title.innerHTML = `@${post.PostId} &middot; ${humanize(post.Time)}`;

        const text = document.createElement("p");
        text.innerHTML = processText(post.Text);

        const link = document.createElement("a");
        link.href = `javascript:setRepliesParam('${post.PostId}')`;
        link.className = "card-link";
        link.innerHTML = `<i class="bi bi-chat me-2"></i>${post.ReplyCount}`;

        card.appendChild(body);
        body.appendChild(title);
        body.appendChild(text);
        body.appendChild(link);

        document.querySelector(POSTS_ID).appendChild(card);
      }

      function setSearchParam(o) {
        const params = new URLSearchParams(window.location.search);
        for (const [k, v] of Object.entries(o)) {
          params.set(k, v);
        }
        window.location.search = params;
      }

      function setTagParam(tag) {
        setSearchParam({
          view: VIEW.TAG,
          tag,
        });
      }

      function setRepliesParam(postId) {
        setSearchParam({
          view: VIEW.REPLIES,
          postId,
        });
      }

      function updateTagChildren(tag) {
        // TODO: #/@ formatting
        document.querySelector(SEARCH_ID).value = parseTag(tag).pretty;
        document.querySelector(COMMENT_ID).placeholder = `Replying to ${
          parseTag(tag).pretty
        }`;

        clearCards();
        fetch(HOST + "/children/" + tag)
          .then((response) => response.json())
          .then((data) => data.forEach(renderCard));
      }

      function getParams() {
        const params = new URLSearchParams(window.location.search);
        return {
          view: params.get("view") || VIEW.TAG,
          tag: params.get("tag") || DEFAULT_TAG,
          postId: params.get("postId"),
        };
      }

      /*

      rendering:
      - updates to screen happen through search params

      i.e. when updating tag, just update search param, which triggers onload


      render:
      1. get params
      2. render

      */

      function renderViewTag(tag) {
        //document.querySelector(SEARCH_ID).value = tag;

        clearCards();
        apiGetTag(tag, renderCard);
      }

      function renderViewReplies(postId) {
        clearCards();
        apiGetReplies(postId, renderCard);
      }

      window.onload = function () {
        const { view, tag, postId } = getParams();
        console.log(view, tag, postId);

        if (view === VIEW.TAG) {
          renderViewTag(tag);
        } else if (view === VIEW.REPLIES) {
          renderViewReplies(postId);
        }

        //updateTagChildren(tag);
      };
    </script>
  </head>
  <body>
    <nav class="navbar navbar-expand sticky-top navbar-light bg-light">
      <div class="container">
        <div class="row g-2 justify-content-md-center">
          <div class="col-auto">
            <input
              class="form-control"
              type="search"
              placeholder="Search"
              id="search"
            />
          </div>
          <div class="col-auto">
            <button
              class="btn btn-outline-secondary"
              onclick="javascript:searchTag()"
            >
              Search
            </button>
          </div>
        </div>
      </div>
    </nav>
    <div class="container">
      <textarea class="form-control mt-3 mb-2" id="comment"></textarea>
      <button class="btn btn-primary" onclick="javascript:postComment()">
        Post
      </button>
      <div id="posts">
        <div class="card mt-3 mb-3">
          <div class="card-body">
            <p class="card-title text-muted mb-3">
              @acc07ed24d5a4ec9ea389577ff772231 &middot; 5h
            </p>
            <p class="card-text">
              In publishing and <a href="#">#GraphicDesign</a>, Lorem ipsum is a
              placeholder text commonly used to demonstrate the
              <a href="#">#visual</a> form of a document or a typeface without
              relying on meaningful content. Lorem ipsum may be used as a
              placeholder before final <a href="#">#copy</a> is available.
            </p>
            <a href="javascript:updateTag(123)" class="card-link"
              ><i class="bi bi-chat"></i> 7</a
            >
          </div>
        </div>
      </div>
    </div>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
