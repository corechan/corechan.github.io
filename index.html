<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css"
    />
    <title>Corechan</title>
    <style>
      a {
        text-decoration: none;
      }
    </style>
    <script>
      const DEFAULT_HOST = "https://tchan.art";
      const POSTS_ID = "#posts";
      const SEARCH_ID = "#search";
      const COMMENT_ID = "#comment";
      const HOST_ID = "#host";
      const DEFAULT_TAG = "home";
      const VIEW = {
        TAG: "tag",
        REPLIES: "replies",
      };

      function humanize(s) {
        const date = Date.parse(s);
        let t = Date.now() - date;
        t /= 1000;
        if (t < 60) {
          return "now";
        }
        t /= 60;
        if (t < 60) {
          return `${Math.floor(t)}m`;
        }
        t /= 60;
        if (t < 60) {
          return `${Math.floor(t)}h`;
        }
        t /= 24;
        return `${Math.floor(t)}d`;
      }

      /**
       * Add links to tags.
       */
      function processText(s) {
        return s.replaceAll(
          /[#@][a-zA-Z0-9]+/gi,
          (match) =>
            `<a href="javascript:setTagParam('${match.substr(
              1
            )}')">${match}</a>`
        );
      }

      function clearCards() {
        document.querySelector(POSTS_ID).innerHTML = "";
      }

      function apiGetPost(host, postId, postCallback) {
        fetch(`${host}/post/${postId}`)
          .then((response) => response.json())
          .then((data) => data.forEach(postCallback));
      }

      function apiGetReplies(host, postId, postCallback) {
        fetch(`${host}/replies/${postId}`)
          .then((response) => response.json())
          .then((data) => data.forEach(postCallback));
      }

      function apiGetTag(host, tag, postCallback) {
        fetch(`${host}/tag/${tag}`)
          .then((response) => response.json())
          .then((data) => data.forEach(postCallback));
      }

      function apiPostPost(host, parentPostId, tags, text) {
        fetch(`${host}/post`, {
          method: "POST",
          body: JSON.stringify({
            ParentPostId: parentPostId,
            Tags: tags,
            Text: text,
          }),
        }).then((response) => window.location.reload());
      }

      function parseTags(s) {
        const matches = s.match(/#[a-zA-Z0-9]+/gi);
        if (matches) {
          return matches.map((match) => match.substr(1));
        }
        return [];
      }

      function postComment() {
        event.preventDefault();
        const text = document.querySelector(COMMENT_ID).value;
        const params = getParams();
        apiPostPost(params.host, params.postId, parseTags(text), text);
      }

      function searchTag(event) {
        event.preventDefault();
        const tag = document.querySelector(SEARCH_ID).value;
        setTagParam(tag);
      }

      function setHost(event) {
        event.preventDefault();
        const host = document.querySelector(HOST_ID).value;
        setHostParam(host);
      }

      function renderCard(post) {
        const card = document.createElement("div");
        card.className = "card mt-3 mb-3";

        const body = document.createElement("div");
        body.className = "card-body";

        const title = document.createElement("p");
        title.className = "card-title text-muted mb-3";
        // TODO: <time>
        title.innerHTML = `@${post.PostId} &middot; ${humanize(post.Time)}`;

        const text = document.createElement("p");
        text.innerHTML = processText(post.Text);

        const link = document.createElement("a");
        link.href = `javascript:setRepliesParam('${post.PostId}')`;
        link.className = "card-link";
        link.innerHTML = `<i class="bi bi-chat me-2"></i>${post.ReplyCount}`;

        card.appendChild(body);
        body.appendChild(title);
        body.appendChild(text);
        body.appendChild(link);

        document.querySelector(POSTS_ID).appendChild(card);
      }

      function setSearchParam(o) {
        const params = new URLSearchParams(window.location.search);
        for (const [k, v] of Object.entries(o)) {
          params.set(k, v);
        }
        window.location.search = params;
      }

      function setTagParam(tag) {
        setSearchParam({
          view: VIEW.TAG,
          tag,
        });
      }

      function setRepliesParam(postId) {
        setSearchParam({
          view: VIEW.REPLIES,
          postId,
        });
      }

      function setHostParam(host) {
        setSearchParam({
          host,
        });
      }

      function getParams() {
        const params = new URLSearchParams(window.location.search);
        return {
          view: params.get("view") || VIEW.TAG,
          tag: params.get("tag") || DEFAULT_TAG,
          postId: params.get("postId"),
          host: params.get("host") || DEFAULT_HOST,
        };
      }

      function renderViewTag(host, tag) {
        document.querySelector(SEARCH_ID).value = tag;

        clearCards();
        apiGetTag(host, tag, renderCard);
      }

      function renderViewReplies(host, postId) {
        document.querySelector(
          COMMENT_ID
        ).placeholder = `Replying to @${postId}`;

        clearCards();
        apiGetReplies(host, postId, renderCard);
      }

      window.onload = function () {
        const { view, tag, postId, host } = getParams();
        console.log(view, tag, postId, host);

        document.querySelector(HOST_ID).value = host;

        if (view === VIEW.TAG) {
          renderViewTag(host, tag);
        } else if (view === VIEW.REPLIES) {
          renderViewReplies(host, postId);
        }
      };
    </script>
  </head>
  <body>
    <nav class="navbar navbar-expand sticky-top navbar-light bg-light">
      <div class="container">
        <form onsubmit="javascript:searchTag(event)" class="input-group">
          <input
            class="form-control"
            type="search"
            placeholder="Search"
            id="search"
          />
          <button class="btn btn-outline-secondary" type="submit">
            Search
          </button>
        </form>
      </div>
    </nav>
    <div class="container mb-3">
      <form onsubmit="javascript:postComment(event)">
        <textarea class="form-control mt-3 mb-2" id="comment"></textarea>
        <button class="btn btn-primary" type="submit">Post</button>
      </form>
      <div id="posts"></div>
    </div>
    <div class="container mb-3">
      <form onsubmit="javascript:setHost(event)" class="input-group">
        <input class="form-control" type="text" placeholder="Host" id="host" />
        <button class="btn btn-outline-secondary" type="submit">
          Set host
        </button>
      </form>
    </div>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
